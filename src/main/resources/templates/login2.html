<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Iniciar Sesión</title>
<link rel="stylesheet" href="Css/login.css">
<link rel="stylesheet" th:href="@{/Css/css.css}">
<link rel="stylesheet" th:href="@{/Css/search.css}">
<!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="icon" type="image/png" th:href="@{/Css/img/logo4.png}">


</head>
<body>
<div class="header">LSJ</div>
    <div class="header-container">
        <a th:href="@{/}" class="logo">
          <img class="logo" th:src="@{/Css/img/logo.png}" alt="Logo de la tienda">
        </a>
    
        <div class="search-container">
          <form class="search-form" action="#" method="get" title="buscar">
              <input type="text" class="search-input" placeholder="Buscar productos..." name="q">
              <button type="text" class="search-button">
                  <i class="fas fa-search"></i>
              </button>
          </form>
      </div>
    

   <div class="icon-container">
            <a th:href="@{/registro}" class="icon" title="Registro">
                <i class="fas fa-user-plus"></i>
            </a>
            <a th:href="@{/catalogo}" class="icon" title="Catálogo">
                <i class="fas fa-book"></i>
            </a>
      <a th:href="@{/carrito}" class="icon icon-cart" title="Carrito de compras">
        <i class="fas fa-shopping-cart"></i>
        <span class="cart-count-badge" data-cart-count aria-live="polite" aria-label="Productos en carrito">0</span>
      </a>
            <a th:href="@{/cuenta}" class="icon account-pill" data-user-account-icon hidden aria-label="Mi cuenta">
                <span class="account-pill-initial" data-user-account-initial>U</span>
            </a>
            </div>
        </div>
    </div>



<div class="container_formulario">
  <!-- Formulario -->
  <div class="form-container">
    <h2>Inicia Sesión</h2>

    <!-- Formulario con id -->
    <form id="loginForm">
      <div class="input-wrapper">
        <input type="email" id="usuario" placeholder="Correo electrónico" required>
      </div>
      <div class="input-wrapper password-wrapper">
        <input type="password" id="clave" placeholder="Contraseña" required>
        <i class="fas fa-eye password-toggle" id="togglePasswordLogin" aria-label="Mostrar contraseña"></i>
      </div>

      <div class="checkbox">
        <input type="checkbox" id="terminos" required>
        <label for="terminos">
          Acepto los <a href="#">Términos</a> y
          <a href="#">Políticas de privacidad</a>.
        </label>
      </div>

      <div class="btn-container">
        <button type="button" class="btn btn-red" onclick="window.location.href='/registro'">
          Registrarse
        </button>
        
        <button type="submit" class="btn btn-outline">
          Iniciar Sesión
        </button>
      </div>

      <!-- Mensaje estilizado -->
      <div id="mensaje" style="display:none; margin-top:10px; padding:8px; border-radius:5px; font-weight:bold;"></div>
    </form>
  </div>

  <!-- Imagen -->
  <div class="image-container">
    <img th:src="@{/Css/img/icono_logo.png}" alt="Imagen Registro">
  </div>
</div>

<script>
// Funcionalidad para mostrar/ocultar contraseña en login
document.getElementById("togglePasswordLogin").addEventListener("click", function() {
  const passwordInput = document.getElementById("clave");
  const icon = this;
  
  if (passwordInput.type === "password") {
    passwordInput.type = "text";
    icon.classList.remove("fa-eye");
    icon.classList.add("fa-eye-slash");
    icon.setAttribute("aria-label", "Ocultar contraseña");
  } else {
    passwordInput.type = "password";
    icon.classList.remove("fa-eye-slash");
    icon.classList.add("fa-eye");
    icon.setAttribute("aria-label", "Mostrar contraseña");
  }
});

document.getElementById("loginForm").addEventListener("submit", async function(e) {
  e.preventDefault(); // Evita que recargue la página

  const correo = document.getElementById("usuario").value.trim();
  const contrasena = document.getElementById("clave").value.trim();
  const mensaje = document.getElementById("mensaje");

  if (!correo || !contrasena) {
    mensaje.textContent = "❌ Por favor completa todos los campos";
    mensaje.style.display = "block";
    mensaje.style.backgroundColor = "#ffebee";
    mensaje.style.color = "#c62828";
    return;
  }

  const payload = {
    correo: correo,
    contrasena: contrasena
  };

  try {
    const res = await fetch("/api/auth/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    
    if (res.ok && data.status === "success") {
      mensaje.textContent = "✅ " + data.message;
      mensaje.style.display = "block";
      mensaje.style.backgroundColor = "#e8f5e8";
      mensaje.style.color = "#2e7d32";
      
      // Redirección basada en si es admin o no
      const adminEmails = ["luigi0972@gmail.com", "sebasmondragon@gmail.com"];
      const esAdmin = adminEmails.includes(correo);

      setTimeout(() => {
        if (esAdmin) {
          window.location.href = "/admin/panel";
        } else {
          window.location.href = "/";
        }
      }, 1000);
    } else {
      mensaje.textContent = "❌ " + (data.message || "Error al iniciar sesión");
      mensaje.style.display = "block";
      mensaje.style.backgroundColor = "#ffebee";
      mensaje.style.color = "#c62828";
    }
  } catch (err) {
    console.error(err);
    mensaje.textContent = "❌ Error de conexión con el servidor";
    mensaje.style.display = "block";
    mensaje.style.backgroundColor = "#ffebee";
    mensaje.style.color = "#c62828";
  }
});
</script>
<script th:src="@{/Css/js/search.js}"></script>
<script th:src="@{/Css/js/cart-badge.js}"></script>
<script th:src="@{/Css/js/session-user.js}" defer></script>
</body>
</html>
